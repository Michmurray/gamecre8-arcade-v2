<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>GameCre8 — Play</title>
<style>
  :root { --fg:#0b0b0f; --line:#e5e7eb; --ui:#f7f7f9; }
  * { box-sizing: border-box }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#fff; color:var(--fg) }
  header { padding:10px 12px; border-bottom:1px solid var(--line); display:flex; gap:8px; align-items:center }
  header input { flex:1; padding:8px 10px; font-size:14px; border:1px solid var(--line); border-radius:10px }
  header button { padding:8px 12px; font-size:14px; border:1px solid var(--line); border-radius:10px; background:var(--ui); cursor:pointer }
  #hud { position:fixed; left:10px; top:58px; background:rgba(255,255,255,.92); border:1px solid var(--line); padding:8px 10px; border-radius:10px; font-size:12px }
  canvas { display:block; width:100vw; height:calc(100vh - 50px) }
</style>
<body>
  <header>
    <input id="prompt" placeholder="Describe a game…" />
    <button id="playBtn">Play</button>
    <button id="home" onclick="location.href='/'">Home</button>
  </header>
  <div id="hud">Loading…</div>
  <canvas id="c"></canvas>

<script>
/* -------- URL + UI -------- */
const qs = new URLSearchParams(location.search);
const promptInput = document.getElementById('prompt');
promptInput.value = qs.get('prompt') || 'hello';
document.getElementById('playBtn').onclick = () => {
  const p = promptInput.value.trim();
  location.href = `./play.html?prompt=${encodeURIComponent(p || 'hello')}`;
};

/* -------- Canvas -------- */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d', { alpha: false });
function fitCanvas(){ const w=innerWidth, h=Math.max(320, innerHeight-50); canvas.width=w; canvas.height=h; }
fitCanvas(); addEventListener('resize', fitCanvas);
function groundY(){ return canvas.height - 60; }

/* -------- Defaults -------- */
const hud = document.getElementById('hud');
let CFG = { speed:3, gravity:0.7, theme:'light', platformRate:0.06, coinRate:0.05, hazardRate:0.03, jump:12, assets:{ background:null, player:null, playerFrame:null } };

function loadImage(src){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=()=>rej(new Error('load fail')); img.src=src; }); }

/* -------- Boot: fetch config + load images -------- */
let BG_IMG=null, PLAYER_IMG=null, GRID=null;
(async function boot(){
  const prompt = promptInput.value || 'hello';
  try {
    const r = await fetch('/api/generate?prompt=' + encodeURIComponent(prompt) + '&nocache=' + Date.now());
    const j = await r.json(); if (j?.config) CFG = j.config;
    if (CFG.assets.background) { try { BG_IMG = await loadImage(CFG.assets.background); } catch {} }
    if (CFG.assets.player)     { try { PLAYER_IMG = await loadImage(CFG.assets.player); } catch {} }
    GRID = CFG.assets.playerFrame || null; // {cols, rows} if provided by API
    hud.textContent = `Prompt: "${prompt}" • theme=${CFG.theme} • speed=${CFG.speed} • gravity=${CFG.gravity}`;
  } catch {
    hud.textContent = `Prompt: "${prompt}" • (API fallback)`;
  }
  startGame();
})();

/* -------- Game state -------- */
let t=0, alive=true, score=0;
let THEME_DARK=false, themeBG, themeGround, themeHaz, themeCoin;
const player = { x:80, y:0, w:36, h:36, vy:0, onGround:false };
const platforms=[], coins=[], hazards=[];
function startGame(){
  THEME_DARK  = CFG.theme === 'dark';
  themeBG     = THEME_DARK ? '#0b1020' : '#eaf6ff';
  themeGround = THEME_DARK ? '#132040' : '#d2e9ff';
  themeHaz    = THEME_DARK ? '#ff4d4f' : '#ef4444';
  themeCoin   = THEME_DARK ? '#ffd166' : '#f59e0b';
  player.y = groundY() - player.h;
  requestAnimationFrame(step);
}

/* -------- Input -------- */
addEventListener('keydown', e => {
  if (['Space','ArrowUp','KeyW'].includes(e.code)) {
    if (player.onGround) { player.vy = -CFG.jump; player.onGround=false; }
    e.preventDefault();
  }
  if (e.code === 'KeyR' && !alive) location.reload();
});

/* -------- Spawning -------- */
function spawn(){
  if (Math.random() < CFG.platformRate) {
    const y = groundY() - (Math.floor(Math.random()*3)*40) - 20;
    platforms.push({ x: canvas.width+50, y, w:120+Math.random()*140, h:12, vx:-CFG.speed - Math.random()*2 });
  }
  if (Math.random() < CFG.coinRate) {
    const y = groundY() - 120 - Math.random()*120;
    coins.push({ x: canvas.width+20, y, r:8, vx:-CFG.speed - 1.5 });
  }
  if (Math.random() < CFG.hazardRate) {
    const y = groundY() - 24;
    hazards.push({ x: canvas.width+20, y, w:24, h:24, vx:-CFG.speed - Math.random()*2 });
  }
}

/* -------- Draw helpers -------- */
function rectOverlap(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }
function circleRectOverlap(cx,cy,cr, r){
  const nx=Math.max(r.x, Math.min(cx, r.x+r.w));
  const ny=Math.max(r.y, Math.min(cy, r.y+r.h));
  const dx=cx-nx, dy=cy-ny; return (dx*dx + dy*dy) <= cr*cr;
}
function drawCoin(x,y,r){
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle=themeCoin; ctx.fill(); ctx.closePath();
  ctx.beginPath(); ctx.arc(x,y,r*0.6,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,.4)'; ctx.fill(); ctx.closePath();
}
let animCol=0;
function drawPlayer(){
  if (!PLAYER_IMG){
    ctx.fillStyle = THEME_DARK ? '#8bd1ff' : '#0b6bcb';
    ctx.fillRect(player.x, player.y, player.w, player.h);
    return;
  }
  // If we have a frame grid (from API), crop from tilesheet. Otherwise draw full image.
  if (GRID && GRID.cols>0 && GRID.rows>0) {
    const tw = Math.floor(PLAYER_IMG.width  / GRID.cols);
    const th = Math.floor(PLAYER_IMG.height / GRID.rows);
    // simple walk anim across columns
    if (t % 6 === 0) animCol = (animCol + 1) % GRID.cols;
    const sx = animCol * tw;
    const sy = 0; // first row is usually the walk row
    ctx.drawImage(PLAYER_IMG, sx, sy, tw, th, player.x, player.y, player.w, player.h);
  } else {
    ctx.drawImage(PLAYER_IMG, player.x, player.y, player.w, player.h);
  }
}

/* -------- Game loop -------- */
function step(){
  t++;

  // Background
  if (BG_IMG) ctx.drawImage(BG_IMG, 0, 0, canvas.width, canvas.height);
  else { ctx.fillStyle = themeBG; ctx.fillRect(0,0,canvas.width,canvas.height); }

  // Ground
  ctx.fillStyle = themeGround;
  ctx.fillRect(0, groundY(), canvas.width, canvas.height - groundY());

  // Spawn & move
  if (t % 8 === 0) spawn();

  player.vy += CFG.gravity;
  player.y += player.vy;
  player.onGround = false;
  if (player.y + player.h >= groundY()) { player.y = groundY() - player.h; player.vy = 0; player.onGround = true; }

  ctx.fillStyle = THEME_DARK ? '#1f2a44' : '#c7d2fe';
  for (let i=platfo

  
